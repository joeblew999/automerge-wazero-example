<!DOCTYPE html>
<html>
<head>
    <title>Text CRDT Test</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .test { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        .pass { background: #d4edda; }
        .fail { background: #f8d7da; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Automerge Text CRDT Test</h1>
    <div id="results"></div>

    <script type="module">
        import * as Automerge from 'https://esm.sh/@automerge/automerge@3.1.2';

        const results = document.getElementById('results');

        function addTest(name, passed, details) {
            const div = document.createElement('div');
            div.className = 'test ' + (passed ? 'pass' : 'fail');
            div.innerHTML = `
                <h3>${passed ? '✅' : '❌'} ${name}</h3>
                <pre>${details}</pre>
            `;
            results.appendChild(div);
        }

        // Test 1: Automerge.js loads correctly
        try {
            addTest('Automerge.js loads', true, `Version: ${Automerge.VERSION || 'unknown'}`);
        } catch (e) {
            addTest('Automerge.js loads', false, e.message);
        }

        // Test 2: Can create document with Text CRDT
        try {
            let doc = Automerge.from({ text: "" });
            const hasText = 'text' in doc;
            addTest('Create document with text property', hasText,
                `doc structure:\n${JSON.stringify(doc, null, 2)}`);
        } catch (e) {
            addTest('Create document with text property', false, e.message);
        }

        // Test 3: Can use updateText to modify
        try {
            let doc = Automerge.from({ text: "" });
            doc = Automerge.change(doc, d => {
                Automerge.updateText(d, ["text"], "Hello World");
            });
            const correct = doc.text === "Hello World";
            addTest('updateText works', correct,
                `Expected: "Hello World"\nGot: "${doc.text}"\nDoc:\n${JSON.stringify(doc, null, 2)}`);
        } catch (e) {
            addTest('updateText works', false, e.message);
        }

        // Test 4: Check if Text is actually a CRDT object
        try {
            let doc = Automerge.from({ text: "" });
            doc = Automerge.change(doc, d => {
                Automerge.updateText(d, ["text"], "Test");
            });

            // Get the raw Automerge document internals
            const saved = Automerge.save(doc);
            const isTextCRDT = saved.length > 50; // Text CRDT binary should be larger than plain string

            addTest('Text is CRDT (not plain string)', isTextCRDT,
                `Saved document size: ${saved.length} bytes\n` +
                `This should be >50 bytes for a Text CRDT\n` +
                `First 20 bytes (hex): ${Array.from(saved.slice(0, 20)).map(b => b.toString(16).padStart(2, '0')).join(' ')}`);
        } catch (e) {
            addTest('Text is CRDT (not plain string)', false, e.message);
        }

        // Test 5: Character-level operations work
        try {
            let doc = Automerge.from({ text: "" });

            // Insert "Hello"
            doc = Automerge.change(doc, d => {
                Automerge.updateText(d, ["text"], "Hello");
            });

            // Change to "Hello World"
            doc = Automerge.change(doc, d => {
                Automerge.updateText(d, ["text"], "Hello World");
            });

            // Change to "Hello Everyone"
            doc = Automerge.change(doc, d => {
                Automerge.updateText(d, ["text"], "Hello Everyone");
            });

            const correct = doc.text === "Hello Everyone";
            const history = Automerge.getHistory(doc);

            addTest('Character-level edits work', correct,
                `Final text: "${doc.text}"\n` +
                `Number of changes: ${history.length}\n` +
                `History:\n${history.map((h, i) => `  ${i+1}. ${h.change.message || '(no message)'}`).join('\n')}`);
        } catch (e) {
            addTest('Character-level edits work', false, e.message);
        }

        // Test 6: Server test - fetch current text
        try {
            const response = await fetch('/api/text');
            const text = await response.text();
            addTest('Server responds to /api/text', response.ok,
                `Status: ${response.status}\n` +
                `Text length: ${text.length}\n` +
                `Content: "${text}"`);
        } catch (e) {
            addTest('Server responds to /api/text', false, e.message);
        }

        console.log('✅ All tests completed!');
    </script>
</body>
</html>
